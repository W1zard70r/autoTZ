import json
from datetime import datetime, timedelta


def get_huge_chat_dataset():
    """
    Генерация 100+ сообщений с 5-6 ветками обсуждения,
    разрывами по времени и перекрестными ссылками.
    """
    base_date = datetime(2026, 2, 24, 10, 0, 0)

    messages = []
    msg_id = 1

    def add_msg(author, text, time_offset_minutes=0, reply_to=None):
        nonlocal msg_id, base_date
        base_date += timedelta(minutes=time_offset_minutes)
        msg = {
            "id": msg_id,
            "type": "message",
            "date": base_date.isoformat(),
            "from": author,
            "text": text
        }
        if reply_to:
            msg["reply_to_message_id"] = reply_to
        messages.append(msg)
        current_id = msg_id
        msg_id += 1
        return current_id

    # --- ТЕМА 1: АВТОРИЗАЦИЯ (OAuth) ---
    # Начало рабочего дня
    m1 = add_msg("Александр", "Коллеги, стартуем спринт. Главная задача - OAuth авторизация.")
    m2 = add_msg("Гриша", "Принял. Будем делать через Google или GitHub?", 2, m1)
    m3 = add_msg("Мария", "На дизайне нарисованы обе кнопки.", 5, m1)
    m4 = add_msg("Александр", "Давайте начнем с Google. GitHub во второй итерации.", 2, m2)
    m5 = add_msg("Гриша", "Ок, тогда я беру либу authlib.", 1, m4)
    add_msg("Сергей", "Только не хардкодьте секреты в код, используйте ENV!", 10)
    add_msg("Гриша", "Обижаешь, Серега. Все будет в .env.", 2)

    # --- ТЕМА 2: ВЫБОР БАЗЫ ДАННЫХ (Спор) ---
    # Пауза 3 часа (Обед + работа)
    base_date += timedelta(hours=3)

    m8 = add_msg("Александр", "Кстати, а куда юзеров складываем? В текущую Монгу?")
    m9 = add_msg("Гриша", "Не, для юзеров и транзакций нужна реляционка. Я за Postgres.", 5, m8)
    m10 = add_msg("Сергей",
                  "Зачем нам зоопарк технологий? У нас уже есть MongoDB на проде. Поднимать еще и Постгрес — это мне лишний геморрой.",
                  2, m9)
    add_msg("Гриша", "Монга не дает ACID. Если платеж отвалится, мы потеряем данные. Нужен PG.", 3)
    add_msg("Мария", "Мне без разницы, главное чтобы API отдавал JSON.", 10)
    add_msg("Сергей", "Ладно. Но если PG упадет, поднимать будешь сам.", 5)
    m14 = add_msg("Александр", "Фиксируем: ставим PostgreSQL 16.", 2)
    add_msg("Гриша", "+", 1, m14)
    add_msg("Сергей", "Ок", 1, m14)

    # --- ТЕМА 3: ПРОБЛЕМЫ С FRONTEND (CORS) ---
    # Следующий день, утро
    base_date += timedelta(hours=18)

    m17 = add_msg("Мария", "Гриша, я стучусь на /api/v1/login и получаю CORS error.", 0)
    m18 = add_msg("Гриша", "Странно, я разрешил localhost:3000.", 10, m17)
    add_msg("Мария", "У меня порт 8080. Поправь конфиг.", 2)
    m20 = add_msg("Сергей", "Это вообще на уровне Nginx надо решать, а не в коде.", 5)
    add_msg("Гриша", "Сергей, мы пока на локалке. На стейдже ты настроишь.", 2, m20)
    add_msg("Мария", "Всё заработало, спасибо.", 15)

    # --- ВНЕЗАПНЫЙ ВОПРОС ПО ТЕМЕ 1 ---
    add_msg("Александр", "Гриша, а refresh token мы храним в httpOnly куке?", 5)
    add_msg("Гриша", "Да, чтобы XSS не прошел.", 2)

    # --- ТЕМА 4: ИНЦИДЕНТ (CRASH) ---
    # Прошло 2 дня. Ночь.
    base_date += timedelta(days=2, hours=14)  # 02:00 ночи

    m25 = add_msg("Zabbix Bot", "[ALERT] High CPU load on production-db (99%)", 0)
    m26 = add_msg("Сергей", "Какого черта? Кто деплоил в пятницу вечером?", 5, m25)
    m27 = add_msg("Гриша", "Я...", 2, m26)
    add_msg("Сергей", "У тебя там запрос без индекса положил базу. Я делаю откат (rollback).", 2)
    add_msg("Гриша", "Понял, смотрю логи. Кажется, это поиск по email.", 5)
    add_msg("Александр", "Что случилось? Почему сервис лежит?", 10)
    add_msg("Сергей", "Гриша залил кривой код. Я откатил. База оживает.", 2)
    add_msg("Гриша", "Сорри. Забыл индекс на поле email_normalized.", 2)

    # --- ТЕМА 5: ОФФТОП (ПИЦЦА) ---
    # Следующий день, обед
    base_date += timedelta(hours=10)

    m33 = add_msg("Елена (HR)", "Ребята, выдыхаем! Давайте закажем пиццу в офис.", 0)
    add_msg("Мария", "О, я за! Пепперони.", 2, m33)
    add_msg("Гриша", "Мне 4 сыра.", 1)
    add_msg("Сергей", "Я пас, у меня созвон с дата-центром.", 2)
    add_msg("Александр", "Мне с грибами.", 1)
    add_msg("Елена (HR)", "Ок, заказала. Через 40 мин будет.", 5)
    add_msg("Мария", "+", 1)
    add_msg("Гриша", "спс", 1)

    # --- ТЕМА 6: НОВАЯ ФИЧА (DARK MODE) ---
    # Через 2 часа
    base_date += timedelta(hours=2)

    m41 = add_msg("Александр", "Вернемся к делам. Клиент хочет темную тему к релизу.", 0)
    m42 = add_msg("Мария", "Это переделывать все CSS переменные... Дня 3 работы.", 5, m41)
    add_msg("Гриша", "Бэкенд это не затрагивает?", 2)
    add_msg("Мария", "Нет, только если хранить настройку в профиле юзера.", 1)
    add_msg("Александр", "Да, надо хранить. Чтобы на телефоне и компе синхронилось.", 2)
    m46 = add_msg("Гриша", "Тогда мне нужно добавить поле `theme` в таблицу users.", 2)
    add_msg("Сергей", "Только миграцию нормально напиши в этот раз!", 2, m46)
    add_msg("Гриша", "Ладно-ладно, напишу и скину тебе на ревью.", 1)

    # --- СМЕШАННЫЙ КОНТЕКСТ ---
    add_msg("Елена (HR)", "Пицца приехала! На кухне.", 15)
    add_msg("Мария", "Бегу!", 1)
    add_msg("Александр", "Мария, после обеда оцени точно сроки по Темной теме.", 2)
    add_msg("Мария", "Хорошо.", 1)

    # --- ДОПОЛНИТЕЛЬНЫЕ ТЕХНИЧЕСКИЕ ДЕТАЛИ (Для проверки глоссария) ---
    base_date += timedelta(hours=4)

    add_msg("Гриша", "Саша, я тут подумал. Для авторизации нам нужен Redis. Хранить сессии в PG медленно.", 0)
    add_msg("Сергей", "Опять новый компонент... Redis есть, но маленький. Какой объем данных?", 5)
    add_msg("Гриша", "Пару мегабайт. Чисто ключи сессий.", 2)
    add_msg("Сергей", "Тогда добро. Дам доступы.", 2)
    add_msg("Александр", "Утверждаем Redis.", 1)

    # --- ЗАВЕРШЕНИЕ ---
    # Пятница вечер
    base_date += timedelta(days=1)

    add_msg("Александр", "Всем спасибо за неделю. Релиз во вторник.", 0)
    add_msg("Мария", "Хороших выходных!", 5)
    add_msg("Сергей", "Я мониторю, если что.", 1)

    # Искусственно раздуваем до 100 сообщений, если не хватило,
    # добавляя мелкий флуд и уточнения в середину (в реальном коде выше было около 60)
    # Здесь просто симулируем активную переписку по багам
    return messages


if __name__ == "__main__":
    data = get_huge_chat_dataset()
    print(json.dumps(data, indent=2, ensure_ascii=False))
    print(f"Всего сообщений: {len(data)}")